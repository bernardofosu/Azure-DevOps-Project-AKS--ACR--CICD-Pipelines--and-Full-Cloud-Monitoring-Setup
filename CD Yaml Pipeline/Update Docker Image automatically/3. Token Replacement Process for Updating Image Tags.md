# ğŸ“ Token Replacement Process for Updating Image Tags (With Emojis)

## âœ… 1. Install Replace Tokens Extension

You **must** install this extension before using `replacetokens@5` in your Azure DevOps YAML.

ğŸ”— Install here: [https://marketplace.visualstudio.com/items?itemName=qetza.replacetokens](https://marketplace.visualstudio.com/items?itemName=qetza.replacetokens)

Steps:

1. ğŸŒ Open the link
2. âš™ï¸ Click **Get it free**
3. ğŸ¢ Select your Azure DevOps organization
4. ğŸ“¥ Click **Install**

âœ” Once installed, Azure DevOps will recognize `replacetokens@5`.

---

## âœ… 2. Create Pipeline Variable: `TAG`

This is the value that will replace your token `#{TAG}#`.

Steps:

1. ğŸ‘¨â€ğŸ’» Go to **Pipelines**
2. âœï¸ Open your pipeline and click **Edit**
3. ğŸ§° Click **Variables** (top-right)
4. â• Add new variable:

| Name    | Value                          |
| ------- | ------------------------------ |
| **TAG** | `17` (or any version you want) |

âœ” Save it.

---

## âœ… 3. Add the Token to Your YAML File

In your `deployment-service.yaml`, ensure this appears:

```yaml
aPIVersion: apps/v1
kind: Deployment
spec:
  template:
    spec:
      containers:
        - name: boardgame
          image: bofosu1/boardgame:#{TAG}#
```

âœ” Replace Tokens will substitute `#{TAG}#` with the value from your pipeline variable.

---

## âœ… 4. Azure DevOps YAML for Token Replacement

Use this exact working YAML:

```yaml
trigger:
  - none

pool:
  name: nakodtech
  demands:
    - agent.name -equals Agent-1

stages:
  - stage: update_yaml
    displayName: "Update YAML Image Tag"

    jobs:
      - job: update_yaml_job
        displayName: "Token Replacement Update"

        pool:
          name: nakodtech
          demands:
            - agent.name -equals Agent-1

        steps:
          - checkout: self
            persistCredentials: true
            clean: true
            fetchDepth: 0

          - task: replacetokens@5
            displayName: "Replace Tokens in deployment-service.yaml"
            inputs:
              rootDirectory: "$(Build.SourcesDirectory)"
              targetFiles: "deployment-service.yaml"
              encoding: "utf-8"
              tokenPattern: "custom"
              tokenPrefix: "#{"
              tokenSuffix: "}#"
              writeBOM: false
              actionOnMissing: "warn"
              keepToken: false
```

---

## âœ… 5. Run the Pipeline ğŸ‰

Before replacement:

```
image: bofosu1/boardgame:#{TAG}#
```

After replacement (example TAG=17):

```
image: bofosu1/boardgame:17
```

âœ” Image tag is updated automatically.

---

# ğŸ” Where to Check the Updated Tag

## ğŸ“ 1ï¸âƒ£ Inside the Pipeline Agent Workspace

File location:

```
~/myagent/_work/<buildID>/s/deployment-service.yaml
```

Example:

```
ubuntu@server:~/myagent/_work/2/s$ cat deployment-service.yaml
```

You will see:

```
image: bofosu1/boardgame:17
```

âœ” This is the version used for deployments.

---

## ğŸ“¦ 2ï¸âƒ£ As a Pipeline Artifact (Recommended)

Add this step:

```yaml
- publish: $(Build.SourcesDirectory)/deployment-service.yaml
  artifact: updated-yaml
```

Then check:
â¡ï¸ **Pipelines â†’ Run â†’ Artifacts â†’ updated-yaml**

You will see the updated file:

```
image: bofosu1/boardgame:17
```

âœ” Best for auditing without logging into the agent.

---

## â­ Summary

- âœ³ï¸ Install Replace Tokens extension
- ğŸ”§ Create pipeline variable **TAG**
- ğŸ§© Add token `#{TAG}#` in YAML
- âš™ï¸ Use `replacetokens@5` task
- ğŸš€ Run pipeline â†’ Image tag updates
- ğŸ” Check updated YAML in workspace or artifact

Let me know if you want to add:
âœ¨ Auto-commit updated YAML to Git
âœ¨ Auto-deploy to Kubernetes using the new tag
âœ¨ Build + push Docker image stage
