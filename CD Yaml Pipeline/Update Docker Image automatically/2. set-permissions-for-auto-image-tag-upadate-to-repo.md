# ğŸ“˜ Fixing Git Push + YAML Auto-Update in Azure DevOps Pipelines  
### âœ… Complete Guide (Permissions, Token, Variables, and Final Working YAML)

---

## ğŸ§© **1. Problem Summary**

Your pipeline needed to:

1. Pull the latest repo changes  
2. Update `deployment-service.yaml`  
3. Commit the update  
4. Push changes back to the repo  

Initially, Git push kept failing with errors such as:

- âŒ `fatal: could not read Password`
- âŒ `non-fast-forward` merge errors
- âŒ Permission denied  
- âŒ System.AccessToken disabled  

All issues are now resolved â€” below is the full working solution.

---

# ğŸ” **2. REQUIRED PERMISSIONS (Correct Security Model)**

Azure DevOps uses **repo-level permissions** to control Git push.

### âœ” REQUIRED Identity (Pipeline Identity)
**Azure DevOps Project Build Service (ofosubernard2026)**

This is the identity used by your pipeline when running:

```yaml
checkout: self
persistCredentials: true
```

---

## ğŸ”’ **2.1 Repo-Level Permissions â€” REQUIRED & SECURE**  

ğŸ“ Path:  
**Project Settings â†’ Repos â†’ Security â†’ Boardgame â†’ Users â†’ Azure DevOps Project Build Service**

Set:

| Permission | Value |
|-----------|--------|
| ğŸ”¹ Read | Allow |
| ğŸ”¹ Contribute | Allow |
| ğŸ”¹ Contribute to pull requests | Allow |
| ğŸ”¹ Create branch | Allow |
| ğŸ”¹ Create tag | Allow |
| ğŸ”¹ Bypass policies when pushing | Optional |

### â­ Why Repo-Level is the BEST  
- Limits access **only** to the repo you choose  
- Protects other repos  
- Excellent for CI/CD (least privilege)  
- Works perfectly with System.AccessToken  

---

## ğŸ” **2.2 You MUST configure these permissions for every future repo**

Azure DevOps does NOT inherit repo permissions across repos.

â¡ Any repo your pipeline will push to must be configured manually.  
â¡ This protects your organization and prevents accidental writes.

---

# ğŸ”‘ **3. Enable System.AccessToken (Mandatory)**

This token allows the pipeline to authenticate to Azure Repos.

ğŸ“ Path:  
**Project Settings â†’ Pipelines â†’ Settings**

Enable:

âœ” **Allow scripts to access the OAuth token**

Without this â†’ Git push will fail every time.

---

# ğŸ§© **4. Configure Pipeline Variables**

Go to:

ğŸ“ Pipelines â†’ Edit â†’ Variables â†’ Add

Add variable:

| Name | Value | Secret |
|------|--------|--------|
| **newImageTag** | e.g., `25` | No |

This allows the pipeline to dynamically update the image tag.

---

# ğŸ›  **5. Fixing the Git Remote URL**

Azure DevOps requires authentication inside the URL:

```
https://$(System.AccessToken)@dev.azure.com/ORG/PROJECT/_git/REPO
```

Your working version:

```
git remote set-url origin https://$(System.AccessToken)@dev.azure.com/ofosubernard2026/Azure%20DevOps%20Project/_git/Boardgame
```

---

# ğŸš€ **6. Final Working Pipeline YAML (Clean, Correct, and Tested)**

```yaml
trigger:
- none

pool:
  name: nakodtech
  demands:
    - agent.name -equals Agent-1

stages:

# --------------------------------------
# ğŸš€ Stage: Manually Update Image Tag
# --------------------------------------
- stage: update_yaml
  displayName: "Manually Update Image Tag"
  jobs:

  - job: update_yaml_job
    displayName: "Update Deployment YAML Image Tag"

    steps:

      # Required for pushing to repo
      - checkout: self
        persistCredentials: true
        clean: true
        fetchDepth: 0

      - script: |
          echo "=== Updating image tag manually in deployment-service.yaml ==="

          git config user.email "pipeline@devops.com"
          git config user.name "Azure DevOps Pipeline"

          echo "Fetching latest main branch..."
          git fetch origin
          git checkout main
          git pull origin main --no-edit

          echo "Updating image tag to $(newImageTag)..."
          sed -i "s|image: bofosu1/bankapp2:.*|image: bofosu1/bankapp2:$(newImageTag)|" deployment-service.yaml

          echo "Updated YAML content:"
          cat deployment-service.yaml

          echo "Fixing repo remote URL..."
          git remote set-url origin https://$(System.AccessToken)@dev.azure.com/ofosubernard2026/Azure%20DevOps%20Project/_git/Boardgame

          git add deployment-service.yaml
          git commit -m "Manually updated image tag to $(newImageTag)" || echo "No changes to commit"

          echo "Pushing changes..."
          git push origin main

        displayName: "Commit Updated YAML Back to Repo"
        env:
          System.AccessToken: $(System.AccessToken)
```

---

# ğŸ§ª **7. Final Validation Checklist**

| Task | Status |
|------|--------|
| Repo-level permissions configured | âœ… |
| System.AccessToken enabled | âœ… |
| Variables configured | âœ… |
| Git remote URL fixed | âœ… |
| YAML auto-update tested | âœ… |
| Git push successful | âœ… |

---

# ğŸ¯ **FINAL SUMMARY**

- âœ… Repo-level permissions alone are sufficient  
- âŒ Project-level permissions not required in your scenario  
- ğŸ” System.AccessToken must be enabled  
- ğŸ— Variables allow easy manual tag updates  
- ğŸ” You must configure repo permissions for every new repo  
- ğŸš€ Pipeline is now fully working and secure  

---

If you want, I can also generate a **PDF**, **DOCX**, or an illustrated diagram. ğŸ˜Š
